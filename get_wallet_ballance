import csv
from web3 import Web3

# Список кошельков (можно добавить несколько)
wallet_addresses = [
    "0xaC65e21575E37dD72A1e1E0cf1BB5EBD33EFD3da",
    "0x548ae35ef8f710897d682a270bcc1b7921b28b2b"
]

# Проверяем корректность адресов
wallet_addresses = [Web3.to_checksum_address(addr) for addr in wallet_addresses]

# Чтение RPC из файла "rpc.txt"
# Формат файла: ChainName,RPC_URL
with open("rpc.txt", "r") as f:
    lines = [line.strip() for line in f if line.strip()]

rpc_list = []
for line in lines:
    parts = line.split(",")
    if len(parts) != 2:
        print(f"[WARN] Invalid line: {line}")
        continue
    chain_name, rpc_url = parts[0].strip(), parts[1].strip()
    rpc_list.append((chain_name, rpc_url))

# Создаём CSV для результатов
output_file = "wallet_balances.csv"
with open(output_file, "w", newline="", encoding="utf-8-sig") as csvfile:
    writer = csv.writer(csvfile)
    writer.writerow(["Wallet Address", "Chain", "Balance (ETH)"])

    # Проходим по всем RPC
    for chain_name, rpc_url in rpc_list:
        try:
            w3 = Web3(Web3.HTTPProvider(rpc_url))
            if not w3.is_connected():
                print(f"[WARN] Cannot connect to {chain_name} RPC")
                continue

            # Проверяем баланс каждого кошелька
            for wallet_address in wallet_addresses:
                try:
                    balance_wei = w3.eth.get_balance(wallet_address)
                    balance_eth = w3.from_wei(balance_wei, "ether")
                    writer.writerow([wallet_address, chain_name, balance_eth])
                    print(f"[{chain_name}] {wallet_address}: {balance_eth} ETH")
                except Exception as e:
                    print(f"[ERROR] {chain_name}, {wallet_address}: {e}")

        except Exception as e:
            print(f"[ERROR] {chain_name}: {e}")

print(f"\n✅ Balances saved to '{output_file}'")
